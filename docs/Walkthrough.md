# Akd Walkthrough

## Prelude

Elixir has been one of the fastest growing programming languages for past three
years. Although there are a lot resources/tools that help you develop in elixir,
there aren't many that do elixir deployments or even talk about it. There
are packages which help us with elixir deployments, but they take too long to
set up (even for a simple app).

In this walkthrough we will be covering the basics of elixir deployments and
how we can make them easier with Annkissam's deployment package: `akd`.

Akd, in its purest form, is a way of executing a list of Operations on a remote
(or local) machine. It comes with DSLs which makes it easier to define a
pipeline of those operations and what to do then any of those operations fail.
If you have used the ruby gem `capistrano`, this will look familier.

Akd's responsibility is to give developers the ability to write those operations
using the elixir interface and provide a standard way to do deployments using
tools like `distillery` or `docker`. We will talk more about akd as we go
further in this walkthrough.


## Example Phoenix App

For this walkthrough, we will use a simple phoenix application, `akd_example`.
The app runs on elixir 1.6.4 and erlang 20.3.4. It uses phoenix 1.3.2, with
ecto and postgrex.
This phoenix app consists of one table/schema `products`. The app uses `brunch`
and `npm`, just like a regular phoenix app. We will be deploying this app to
a server with ip, 192.168.xx.xx.

The simplest way to run a phoenix app is to get all the dependencies using
`mix deps.get` and run it using `mix phx.server`. This is a great for
development mode, but the recommended way to use it in production is through a
built release and the preferred way to release an elixir application is by
using `distillery`. Distillery allows us to release an elixir application as
a built binary, hence we don't have to put the source code of the application
on the server we're deploying to.

So, we will be using `distillery` and `akd` to deploy our phoenix app.


## Setting up the project with Akd and Distillery

One thing to point out here is that `akd` generates a mix task which allows us
to deploy an application. But a mix task has to be part of an elixir application.
The simplest thing to do is to add `akd` to the app which you are deploying,
but then you would need to `akd` as a dependency in all the environments as
it creates a mix task which needs to be compiled in all the environments.
I recommend creating a new app in the root folder named `<app_name>_deployer`,
whose responsibility is to just deploy the app, `<app_name>`. In this way, we
don't affect the dependencies of the original app and we could also use the
app `<app_name>_deployer` to deploy non elixir apps.

So, let's create a new mix project in the root folder of the app `akd_example`
by using the command `$ mix new akd_example_deployer` and add `akd` as a
dependency in the `mix.exs`:

```elixir
# akd_example_deployer/mix.exs

defp deps do
  [{:akd, "~> 0.2", only: :dev, runtime: false}]
end
```

Once we run the command `$ mix deps.get` from `akd_example_deployer`'s root
directory, we will have access to `akd`'s mix tasks.

Once you run the command `$ mix akd.gen.task` it will print out the usage
of the task. For simplicity, let's use all the default hooks and run the task
as `$ mix akd.gen.task Deploy --with-phx`. This will generate a mix task by
creating a file `akd_example_deployer/lib/mix/tasks/akd/deploy.ex`.

The file will have a lot of autogenerated code and defaults. First, we will
change the defaults. Replace the autogenerated `@defaults` with:

```elixir
@defaults [name: "akd_example", build_at: "user@192.168.xx.xx:~/path/to/app",
           env: "prod", publish_to: "user@192.168.xx.xx:~/path/to/app",
           vsn: "0.0.1"]
```

Next, we can give the `Akd.Fetch.Git` hook some parameters to clone the source
code of the application:

```elixir

pipeline :fetch do
  hook Akd.Fetch.Git, branch: "master",
    src: "git@github.com:annkissam/akd_example.git",
    run_ensure: false
end
```

Next, we can give `Akd.Build.Phoenix.Npm` and `Akd.Build.Phoenix.Brunch` hooks
their parameters to allow `akd` to call commands like `$ npm install` and
`brunch build`:

```elixir
hook Akd.Build.Phoenix.Npm,
  package: "./assets" # This is the path to package.json file

hook Akd.Build.Phoenix.Brunch,
  config: "./assets", # This is the path to brunch-config file
  brunch: "./assets/node_modules/brunch/bin/brunch" # Path to brunch binary
```

Now, the app is ready to be deployed! Just run `mix akd.deploy` and make sure
that you have ssh credentials to the server (192.168.xx.xx).
